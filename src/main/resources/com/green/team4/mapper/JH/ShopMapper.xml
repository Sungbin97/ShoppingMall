<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.green.team4.mapper.JH.ShopMapper">
    <select id="getListAll" resultType="com.green.team4.vo.sb.ProductVO">
        select * from tbl_product where pno>0
    </select>
    <!--    <select id="getListWithCategory" resultType="com.green.team4.vo.sb.ProductVO">-->
    <!--        select * from product where p_category = #{p_category}-->
    <!--    </select>-->


    <select id="getOne" resultType="com.green.team4.vo.sb.ProductVO">
        select * from tbl_product where pno=#{pno}
    </select>
    <select id="getOneWithOpt" resultType="com.green.team4.vo.sb.ProductVO">
       select p.pno,ps.pcno,ps.pColor,ps.pOption,ps.pOption2,ps.pOptionName,ps.pOptionName2  from tbl_product p
         inner join tbl_product_opt ps on p.pno = ps.pno
        where p.pno = #{pno};
    </select>
    <select id="getOneWithPno" resultType="com.green.team4.vo.sb.ProductVO">
        select p.pno,pName,pPrice,pDiscount,pImage,ps.pColor,ps.pAmount,ps.pcno,ps.pColor,ps.pOption,ps.pOption2,ps.pOptionName,ps.pOptionName2  from tbl_product p
                                                                                                       inner join tbl_product_opt ps on p.pno = ps.pno
        where p.pno = #{pno};
    </select>
    <select id="getProductWithOpt" resultType="com.green.team4.vo.JH.Product_optVO">
        select p.pno,pName,pPrice,pDiscount,pImage,ps.pColor,ps.pAmount,
               ps.pOption,ps.pOptionName,ps.pOption2,ps.pOptionName2,ps.pOptionPrice  from tbl_product p
       inner join tbl_product_opt ps on p.pno = ps.pno
        where p.pno = #{pno} <include refid="price"></include>
    </select>

    <insert id="insert">
        insert into tbl_product (pName,pPrice,pAmount,pImage,pInformation,pCateCode)
        values (#{pName},#{pPrice},#{pAmount},
                #{pImage},#{pInformation},#{pCateCode})
    </insert>

    <select id="getColors" resultType="com.green.team4.vo.JH.Product_optVO">
        select distinct ps.pColor from tbl_product p
                                           inner join tbl_product_opt ps on p.pno = ps.pno
        where p.pno = #{pno} and ps.pAmount != 0
    </select>
    <select id="getOptions" resultType="com.green.team4.vo.JH.Product_optVO">
        select distinct ps.pOption ,ps.pOptionName from tbl_product_opt P
                                            inner join tbl_product_opt ps on p.pno = ps.pno
        where p.pno = #{pno} and ps.pAmount != 0
    </select>
    <select id="getOptions2" resultType="com.green.team4.vo.JH.Product_optVO">
        select distinct ps.pOption2 ,ps.pOptionName2 from tbl_product_opt P
                                            inner join tbl_product_opt ps on p.pno = ps.pno
        where p.pno = #{pno} and ps.pAmount != 0
    </select>
        <!--    restful용-->
        <select id="getOptList" resultType="com.green.team4.vo.JH.Product_optVO">
            select * from tbl_product_opt

            where pno = #{pno}  and pAmount !=0   <include refid="option"></include>
        </select>
        <select id="getOptionPrice" resultType="com.green.team4.vo.JH.Product_optVO">
            select P.pPrice,pOptionPrice, ps.pAmount from tbl_product P
            inner join tbl_product_opt ps on p.pno = ps.pno
            where p.pno = #{pno} and ps.pAmount !=0 <include refid="price"></include>
        </select>
    <sql id="option">
        <if test="pColor == '' and pColor == '' and pOption =='' ">

        </if>
        <if test="pColor != null and pColor != '' and pOption =='' ">
            and pColor = #{pColor}
        </if>
        <if test="pOption != null and pOption != '' and pColor ==''">
            and pOption = #{pOption}
        </if>
        <if test="pColor != null and pColor != '' and pOption != null and pOption != ''">
            and pColor = #{pColor} and  pOption = #{pOption}
        </if>

    </sql>
    <sql id="price">
        <if test="(pColor == null and pColor =='') and (pOption ==null or pOption =='') and (pOption2 == null or pOption2 =='') ">

        </if>
        <if test="(pColor != null and pColor !='') and (pOption ==null or pOption =='') and (pOption2 == null or pOption2 =='') ">
            and ps.pColor = #{pColor} and ps.pOption is null and ps.pOption2  is null
        </if>
        <if test="(pColor == null or pColor =='' )and (pOption !=null and pOption !='') and (pOption2 == null or pOption2 =='') ">
            and ps.pColor is null and ps.pOption = #{pOption} and  ps.pOption2  is null
        </if>
        <if test="(pColor != null and pColor !='') and (pOption !=null and pOption !='') and (pOption2 == null or pOption2 =='') ">
            and ps.pColor = #{pColor} and ps.pOption = #{pOption} and ps.pOption2  is null
        </if>
        <if test="(pColor == null or pColor =='') and (pOption !=null and pOption !='') and (pOption2 !=null and pOption2 !='') ">
            and  ps.pColor is null and ps.pOption= #{pOption} and ps.pOption2 = #{pOption2}
        </if>
        <if test="(pColor != null and pColor !='') and (pOption !=null and pOption !='') and (pOption2 !=null and pOption2 !='') ">
            and ps.pColor = #{pColor} and  ps.pOption = #{pOption} and ps.pOption2 = #{pOption2}
        </if>

    </sql>
   


    <!--    페이징-->

    <!--    <select id="getListByCategoryAndPage" resultType="com.green.team4.vo.sb.ProductVO"-->
    <!--            parameterType="Map" >-->
    <!--        select * from product where pCategory = #{p_category} order by pno desc ,pRegdate desc-->
    <!--            limit #{pagingVO.cri.startPage}, #{pagingVO.cri.numPerPage}-->

    <!--    </select>-->

    <!--   하위 카테고리-->



<!--    <select id="getListByFind" resultType="com.green.team4.vo.sb.ProductVO">-->
<!--        select * from tbl_product-->
<!--        where-->
<!--        <include refid="keyword"></include>-->
<!--        <include refid="sort"></include>-->
<!--        limit #{startPage}, #{numPerPage}-->
<!--    </select>-->
    <select id="getListByFind" resultType="com.green.team4.vo.sb.ProductVO">
        select * from tbl_product P
        left outer join tbl_product_cate PC on P.pCateCode = PC.pCateCode
        <include refid="criteria"></include>
        <include refid="sort"></include>
        limit #{startPage}, #{numPerPage}
    </select>
    <select id="getTotaldatabyFind" resultType="int">
        select count(pno) from tbl_product P
        left outer join tbl_product_cate PC on P.pCateCode = PC.pCateCode
        <include refid="criteria"></include>
        <include refid="sort"></include>
    </select>

    <select id="getListBySearch" resultType="com.green.team4.vo.sb.ProductVO">
        select * from tbl_product
        where pName like concat('%',#{keyword},'%')
        order by pno desc limit 5
    </select>
    <select id="getListByRand" resultType="com.green.team4.vo.sb.ProductVO">
        select * from tbl_product
        where pCateCode like concat('%',#{keyword},'%')
        order by rand() limit 10
    </select>
    <sql id="keyword">

        <if test="keyword != null and keyword != '' "  >
            pName like concat('%',#{keyword},'%')
        </if>

    </sql>
    <sql id="criteria">
        <trim prefix="where (" suffix=")" prefixOverrides="and" >
            <trim prefix="and">
                <choose>
                    <when test="pCateCode != null and pCateCode != ''">
                        P.pCateCode like concat(#{pCateCode},'%')
                    </when>
                    <when test="keyword != null and keyword != ''">
                        P.pName like concat('%',#{keyword},'%')
                    </when>
                </choose>
            </trim>
        </trim>
    </sql>
<!--    <sql id="mainCategory">-->

<!--        <if test="main_category != null and main_category != ''">-->
<!--            <if test="main_category == '의류'">-->
<!--                pMainCategory ='의류'-->
<!--            </if>-->
<!--            <if test="main_category == '식품'">-->
<!--                pMainCategory ='식품'-->
<!--            </if>-->
<!--            <if test="main_category == '운동용품'">-->
<!--                pMainCategory ='운동용품'-->
<!--            </if>-->
<!--        </if>-->

<!--    </sql>-->
<!--    <sql id="subCategory">-->
<!--        <if test="sub_category != null and sub_category != ''">-->
<!--            <if test="sub_category == '비타민C'">-->
<!--                and  pSubCategory = '비타민C'-->
<!--            </if>-->
<!--            <if test="sub_category == '비타민D'">-->
<!--                and  pSubCategory = '비타민D'-->
<!--            </if>-->
<!--            <if test="sub_category == '종합 비타민'">-->
<!--                and  pSubCategory = '종합 비타민'-->
<!--            </if>-->
<!--            <if test="sub_category == '오메가3'">-->
<!--                and  pSubCategory = '오메가3'-->
<!--            </if>-->
<!--            <if test="sub_category == '아르기닌'">-->
<!--                and  pSubCategory = '아르기닌'-->
<!--            </if>-->
<!--            <if test="sub_category == '티셔츠'">-->
<!--                and  pSubCategory = '티셔츠'-->
<!--            </if>-->
<!--            <if test="sub_category == '셔츠'">-->
<!--                and  pSubCategory ='셔츠'-->
<!--            </if>-->
<!--            <if test="sub_category == '기능성티'">-->
<!--                and  pSubCategory = '기능성티'-->
<!--            </if>-->
<!--            <if test="sub_category == '런닝복'">-->
<!--                and  pSubCategory ='런닝복'-->
<!--            </if>-->
<!--            <if test="sub_category == '반팔티'">-->
<!--                and  pSubCategory ='반팔티'-->
<!--            </if>-->
<!--            <if test="sub_category == '벤치프레스'">-->
<!--                and  pSubCategory = '벤치프레스'-->
<!--            </if>-->
<!--            <if test="sub_category == '로잉머신'">-->
<!--                and  pSubCategory = '로잉머신'-->
<!--            </if>-->
<!--            <if test="sub_category == '철봉'">-->
<!--                and  pSubCategory ='철봉'-->
<!--            </if>-->
<!--            <if test="sub_category == '런닝머신'">-->
<!--                and  pSubCategory = '런닝머신'-->
<!--            </if>-->
<!--            <if test="sub_category == '덤벨'">-->
<!--                and  pSubCategory = '덤벨'-->
<!--            </if>-->
<!--        </if>-->
<!--    </sql>-->
    <sql id="sort">

        <if test="sort == '' ">
            order by pno desc
        </if>
        <if test="sort == 'new' ">
            order by pno desc
        </if>
        <if test="sort == 'pricedesc' ">
            order by pPrice desc
        </if>
        <if test="sort == 'priceasc' ">
            order by pPrice asc
        </if>
        <if test="sort == 'reviewCntDesc'">
            order by pReviewCnt desc
        </if>
        <if test="sort == 'ratingDesc'">
            order by pRating desc
        </if>
    </sql>
</mapper>