<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.green.team4.mapper.JH.OrderPageMapper">
    <select id="getProductsInfo" resultType="com.green.team4.vo.JH.OrderPageItemVO">
        select pno,pName,pPrice,pDiscount,pImageURL from tbl_product where pno = #{pno}
    </select>
    <select id="getProductsInfoWithOpt" resultType="com.green.team4.vo.JH.OrderPageItemVO">
        select p.pno,pName,pPrice,pDiscount,pImageURL,ps.pColor,ps.pAmount, ps.pOption ,ps.pOptName,ps.pOption2 ,ps.pOptName2 from tbl_product p
         inner join tbl_product_opt ps on p.pno = ps.pno
        where p.pno = #{pno} and <include refid="option"></include>
    </select>
    <sql id="option">
        <if test="pColor != null and pColor != '' and pOption == ''">
            ps.pColor = #{pColor} and  ps.pOption = '없음' and  ps.pOption2 = '없음'
        </if>
        <if test=" pColor == '' and pOption != null and pOption != '' and pOption2 == ''" >
            ps.pColor = '없음'  and  ps.pOption = #{pOption} and  ps.pOption2 = '없음'
        </if>
        <if test=" pColor == '' and pOption2 != '' and pOption != ''">
            ps.pColor = '없음'  and  ps.pOption = #{pOption} and  ps.pOption2 = #{pOption2}
        </if>
        <if test=" pColor != '' and pOption2 == '' and pOption != ''">
            ps.pColor =  #{pColor}  and  ps.pOption = #{pOption} and  ps.pOption2 = '없음'
        </if>
        <if test="pColor != null and pColor != '' and pOption != null and pOption != '' and pOption2 != null and pOption2 != ''" >
            ps.pColor = #{pColor}  and  ps.pOption = #{pOption} and  ps.pOption2 = #{pOption2}
        </if>

    </sql>
<!--    주문 정보 가져오기-->
    <select id="getOrderInfo" resultType="com.green.team4.vo.JH.DBOrderItemVO">
        select pno,pName,pPrice,pDiscount,pImageURL from tbl_product where pno = #{pno}
    </select>
    <select id="getOrderInfoWithOpt" resultType="com.green.team4.vo.JH.DBOrderItemVO">
        select p.pno,pName,pPrice,pDiscount,pImageURL,ps.pColor,ps.pAmount,ps.pOption ,ps.pOptName,ps.pOption2 ,ps.pOptName2  from tbl_product p
       inner join tbl_product_opt ps on p.pno = ps.pno
        where p.pno = #{pno} and ps.pColor = #{pColor} and ps.pOption=#{pOption} and ps.pOption2=#{pOption2}
    </select>
<!--    주문 테이블 등록-->
    <insert id="enrollOrder">
       insert into tbl_order
       (ono,pno, receiverName, mno, postcode, address, detailAddress, deliveryStatus, shipFee, usePoint,payStatus,productPrice,totalPrice,receiverPhone,count,message)
    	values
    	(#{ono},#{pno},#{receiverName}, #{mno}, #{postcode}, #{address}, #{detailAddress}, '배송준비', #{shipFee}, #{usePoint},'결제완료',#{orderSalePrice},${orderFinalSalePrice},#{phoneNum},#{count},#{message})
    </insert>

<!-- 주문 상품 테이블 등록 -->
	<insert id="enrollOrderItem">

		insert into tbl_orderitem(ono, pno, itemCount, pPrice, pDiscount, savePoint ,pOption,pColor)
		values(#{ono}, #{pno}, #{itemCount}, #{pPrice}, #{pDiscount}, #{savePoint},#{pOption},#{pColor})

	</insert>
	
<!--	회원 포인트 차감-->
    <update id="deductMoney">
        update tbl_memberInfo set  point=#{point} where mno = #{mno}
    </update>
<!--주문 재고 차감-->
    <update id="deductStockWithOpt">
         update tbl_product_opt set pAmount = #{pAmount} where pno = #{pno} and pColor=#{pColor} and pOption=#{pOption} and pOption2=#{pOption2}
    </update>
    <update id="deductStock">
         update tbl_product set pAmount = #{pAmount} where pno = #{pno}
    </update>
<!--    장바구니 삭제(주문한거만)-->
<!--    <delete id="deleteOrderCart">-->
<!--	-->
<!--		delete from 장바구니 테이블 where mno = #{mno} and pno = #{pno}-->
<!--	-->
<!--	</delete>-->
</mapper>